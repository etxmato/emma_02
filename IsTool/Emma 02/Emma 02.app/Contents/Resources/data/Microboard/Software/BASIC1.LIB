-1,2
..
..  BASIC1 SUBROUTINE LIBRARY VERSION 2.0 FOR ASM8 ON MCDOS
8,6
..
..  SGN FUNCTION
..
SGN      GHI AC;SHL;LBDF $+12;ADI 0FFH
         GLO AC;LSDF;ADI 0FFH;LDI 0;LSKP
         LDI 0FFH;PHI AC;SHLC;PLO AC;EXIT
1164,4
..
..  ABS FUNCTION
..
ABS      GHI AC;SHL;LSDF;EXIT;NOP
5292,5
..
..  SUBTRACT AC FROM 0000
..
NEG      GLO AC;SDI 0;PLO AC
         GHI AC;SDBI 0;PHI AC;EXIT
36,6
..
..  ADD/SUB STACK TO AC
..
SUB      CALL NEG
ADD      SEX ES;GLO AC;ADD;PLO AC;INC ES
         GHI AC;ADC;PHI AC;INC ES;EXIT
16,7
..
..  MAX & MIN & MOD FUNCTIONS
..
MAX      CALL IF0T;LBR MIX
MIN      CALL IF1T
MIX      LSNF;EXIT;NOP
MOX      DEC ES;DEC ES;LDA ES;PLO AC;LDA ES;PHI AC;EXIT
4,19
..
..  RANDOM NUMBER GENERATOR
..
RND      SEX ES;GLO AC;SM;PLO AC;INC ES
         GHI AC;SMB;PHI AC;DEC ES;INC AC
         CALL PUSH;SEP L;DC A.0(RNDN)
         SEX ES;DEC ES;LDI 01AH;STXD
         LDI 085H;STXD;LDI 9;STXD
         LDI 029H;STR ES;CALL MPY
         CALL ADD;SEP S;DC A.0(RNDN)
         GHI AC;PLO AC;LDN XX;PHI AC
         CALL RDS;CALL RDS
         CALL RDS;CALL ABS
         CALL DIV;CALL MPY
         CALL SUB;CALL ABS
         INC ES;INC ES;LBR ADD
RDS      GLO ES;PLO XX;CALL PUSH
         LDA XX;PLO AC;LDA XX;PHI AC;EXIT
RNDN     EQU  VARS
4164,12
..
..  MULTIPLY AC * ES STACK
..
MPY      LDI 16;PLO RF;LDI 0;PHI XX;PLO XX
         SEX ES
MPYL     GLO AC;SHR;LBNF MPYS
         GLO XX;ADD;PLO XX;INC ES
         GHI XX;ADC;DEC ES;SKP
MPYS     GHI XX;SHRC;PHI XX;GLO XX;SHRC;PLO XX
         GHI AC;SHRC;PHI AC;GLO AC;SHRC;PLO AC
         DEC RF;GLO RF;LBNZ MPYL
         INC ES;INC ES;EXIT
1156,20
..
..  DIVIDE ES STACK/AC
..
DIV      GHI AC;STR 2;GLO AC;OR;ADI 0FFH
         INC ES;LDA ES;LBDF DOK;CALL UCALL,A.0(CDENT);EXIT
DOK      XOR;STXD;DEC ES;DEC ES;CALL ABS
         GHI AC;PHI XX;GLO AC;PLO XX;LDA ES
         PLO AC;LDN ES;PHI AC;CALL ABS
         SEX ES;LDI 0;STXD;STR ES
         LDI 17;PLO RF
DIVL     GLO XX;SD;STR 2;INC ES
         GHI XX;SDB;LBNF DIVS
         STXD;LDN 2;STR ES;SKP
DIVS     DEC ES;GLO AC;SHLC;PLO AC
         GHI AC;SHLC;PHI AC
         DEC RF;GLO RF;LBZ DIVX
         LDN ES;SHLC;STR ES;INC ES
         LDN ES;SHLC;STXD;LBR DIVL
DIVX     INC ES;INC ES;INC 2;LDN 2
MODX     SHL;LBDF NEG;EXIT
8192,10
..
..  COMPUTED GOTO TABLE FETCH
..
GOTO     LDI A.1(TABLE);PHI XX;LDI TABLE;PLO XX
         SEX 2;GHI 6;STXD;GLO 6;STXD;SEX XX
GOTOL    LDX;ADI 0FFH;GHI AC;XOR;INC XX
         LSNZ;GLO AC;XOR;LBZ GOT
         LDX;ADCI 0;ADCI 0;INC XX
         INC XX;INC XX;LBNZ GOTOL;CALL UCALL,A.0(CDENT);EXIT
GOT      INC XX;LDA XX;PHI 6;LDA XX;PLO 6;EXIT
6657,5
..
..  PRINT STRING
..
STRNL    XRI 09FH;CALL OUCH
STRNG    LDA 6;XRI 09FH;LBNZ STRNL;EXIT
6144,7
..
..  PRINT END LINE (CRLF)
..
LEND     LDI 6;PHI RF
         DEC RF;GHI RF;LBNZ $-2
CRLF     CALL STRNG,0DH
         DC 0A9FH;LDN XX;ANI 0E0H;STR XX;EXIT
1792,5
..
..  PRINT TAB
..
TAB      LDI 020H;CALL OUCH
         LDA XX;ANI 7;LBNZ TAB;EXIT
7936,6
..
..  OUTPUT A CHARACTER
..
OUCH     PHI RF;LDI A.1(TTYCC);PHI XX;LDI TTYCC;PLO XX
         LDN XX;ADI 1;ANI 0EFH;STR XX;SHL
         GHI RF;LBNF PUTCH;EXIT
1024,13
..
..  PRINT A NUMBER
..
PRN      GHI AC;SHL;LBNF PRP;LDI 02DH
         CALL OUCH;CALL NEG
PRP      LDI 0;STXD
PRPL     CALL PUSH
         LDI 0;PHI AC;LDI 10;PLO AC
         CALL DIV;DEC ES;DEC ES
         LDA ES;INC ES;ORI 030H;STXD
         GHI AC;STR 2;GLO AC;OR;LBNZ PRPL
PRNP     INC 2;LDN 2;LSNZ;EXIT;NOP
         CALL OUCH;LBR PRNP
256,13
..
..  PRINT A HEX NUMBER
..
HEX      SMI 1;LBZ HEX1
         SMI 1;LBZ HEX2
         SMI 1;LBZ HEX3
         GHI AC;CALL HEXL
HEX3     GHI AC;CALL HEXR
HEX2     GLO AC;CALL HEXL
HEX1     GLO AC;LBR HEXR
HEXL     SHR;SHR;SHR;SHR
HEXR     ANI 00FH;SMI 10;LSDF;SMI 7
         ADI 041H;LBR OUCH
4096,58
..
..  INPUT NEW LINE
..
RUBOUT   DEC XX;GLO XX;.XOR.A.0(LINE)
         LBZ CANC;@XX->RF.1;XX.1->@-;XX.0->@-;RF.1
         CALL CHOUT;INC R2;@!->XX.0;@R2->XX.1;LBR INCH
GETLF    LDI 080H;LSKP
GETXF    LDI 0;STR 2;LDI TTYCC;PLO XX
         LDN XX;ANI 07FH;OR;STR XX
         SMI 0;LBR GETN
BACKS    XX.1->@-;XX.0->@-
         CALL STRNG;DC 2008H,9FH          ..ASCII SPACE,BS
         INC R2;@!->XX.0;@R2->XX.1
         DEC XX;GLO XX;SMI LINE;LBDF INCH
CANC     CALL LEND
GETLN    CALL STRNG,3F20H,919FH
         ADI 0
GETN     LDI A.1(INPTR);PHI XX;LDI INPTR;PLO XX
         LDI LINE;LSNF;LDA XX;SKP;STR XX;PLO XX
INCH     CALL GETCH;->@R2
         .XOR.7FH;LBZ RUBOUT              ..ASCII RUBOUT
         .XOR.(7FH.XOR.0AH);LBZ GETLF     ..ASCII LINE FEED
         .XOR.(0AH.XOR.13H);LBZ GETXF     ..ASCII DC3
         .XOR.(13H.XOR.3);LBZ CANC        ..ASCII CANCEL (CNTRL X)
         .XOR.(3.XOR.8);LBZ BACKS         ..ASCII BACKSPACE
         @R2;->@XX;.XOR.0DH               ..ASCII CARRIAGE RETURN
         LBZ LEND;INC XX;GLO XX;SMI A.0(VARS-8)
         LSNF;DEC XX;NOP;LBR INCH
..
..  INPUT NUMBER TO AC
..
         CALL GETLN
INPUT    SEP L;DC A.0(INPTR-1);PLO XX;LDI 0;PLO AC;PHI AC
         PLO RF;PHI RF;SKP;DEC RF
INPUL    LDA XX;LSZ;XRI 00DH;LBZ INPUT-3
         XRI 020H;LBZ INPUL-1
         XRI 001H;LBZ INPUL
         XRI 00FH;LBZ IHEX
         XRI 003H;LBZ INPUL
INPUN    XRI 020H;SMI 03AH;LBDF INPUX
         ADI 10;LBNF INPUX;STXD
         GLO XX;STXD;DEC ES;LDI 0;STR ES
         DEC ES;LDI 10;STR ES;CALL MPY
         LDI A.1(LINE);PHI XX;INC 2;LDA 2;PLO XX
         GLO AC;ADD;PLO AC;GHI AC;ADCI 0;PHI AC
INPUS    LDA XX;XRI 020H;LBZ INPUS
         LBR INPUN
IHEX     LDA XX;SMI 020H;LBZ IHEX;LSNF
         SMI 010H;LBNF INPUX;STR 2
         SMI 15;ORI 8;LSNF;STR 2;NOP
         LDI 4;PLO RF
IHEX4    GLO AC;SHL;PLO AC;GHI AC;SHLC;PHI AC
         DEC RF;GLO RF;LBNZ IHEX4
         GLO AC;OR;PLO AC;LBR IHEX
INPUX    DEC XX;GLO XX;STR 2;LDI INPTR;PLO XX
         LDN 2;STR XX;GHI RF;LBZ ISTOR
         CALL NEG
ISTOR    LDA 6;INC S;SEP S;EXIT
-1,31
..
..  STORE VARIABLE FROM AC
..
         SEP 3
STORE    LDA 3;PLO XX;LDI A.1(VARS);PHI XX
         GHI AC;STR XX;INC XX;GLO AC;STR XX
         LBR STORE-1
..
..  LOAD VARIABLE TO AC
..
         SEP 3
LOAD     LDA 3;PLO XX;LDI A.1(VARS);PHI XX
         LDA XX;PHI AC;LDN XX;PLO AC;LBR LOAD-1
..
..  PUSH AC INTO STACK
..
PUSH     DEC ES;GHI AC;STR ES
         DEC ES;GLO AC;STR ES;EXIT
..
..  COMPARE AC TO ES STACK
..
IF0T     LDA ES; STR 2;GLO AC;SM;STXD
         LDA ES;XRI 080H;STR 2;GHI AC;XRI 080H
         SMB;INC 2;OR;EXIT
IF1T     LDA ES; STR 2;GLO AC;SD;STXD
         LDA ES;XRI 080H;STR 2;GHI AC;XRI 080H
         SDB;INC 2;OR;EXIT
..
..  I/O SELECTION
..
CHIN     EQU $
1,6
         GHI ES;PHI RF;LDI TTYCC
         PLO RF;LDA RF;ANI 040H;LBZ 0813EH
         GHI ES;PHI RC;LDI 15;PLO RC
         CALL SNCR;CALL UCALL,A.0(GETCHR),IOCBR
         CALL SCERR,IOCBR;CALL ROCR;LDI 80H
         PHI RC;LDI 0EFH;PLO RC;GHI RF;EXIT
24320,1
         LBR 0813EH
-1,1
CHOUT    EQU $
24321,1
         SEX 2;STXD
1,7
         STR 2;GHI ES;PHI RF;LDI TTYCC
         PLO RF;LDA RF;ANI 020H;LBZ CHOX
         GHI ES;PHI RC;LDI 12;PLO RC;LDN 2
         PHI RF;CALL SNCR;CALL UCALL,A.0(PUTCHR),IOCBW
         CALL SCERR,IOCBW;CALL ROCR
         LDI 080H;PHI RC;LDI 0EFH;PLO RC;INC 2;LDN 2;EXIT
CHOX     LDN 2
24321,1
         CALL 81A5H;INC 2;LDN 2
-1,1
         EXIT
1,5
..
..  DISC I/O CONTROL
..
WEOF     CALL DOUT
         CALL STRNG,130DH,9FH
16385,2
TOUT     SEP L;DC A.0(TTYCC-1);ANI 5FH;STR XX;EXIT
TIN      SEP L;DC A.0(TTYCC-1);ANI 0BFH;STR XX;EXIT
16384,1
NOUT     SEP L;DC A.0(TTYCC-1);ORI 80H;STR XX;EXIT
1,215
DIN      CALL TIN;ORI 40H;STR XX;EXIT
DOUT     CALL TOUT;ORI 20H;STR XX;EXIT
OINIT                                ..START INITIALIZATION
OPEN     EQU 000H;
SRNAM    EQU 024H;
SRNERR   EQU 0B452H
TMPRG1   EQU 0;
TMPRG2   EQU 7;
IOCBPT   EQU 1;
SPACE    EQU 020H
WRITEP   EQU 9;
CLOSE    EQU 002H;
GETCHR   EQU 008H;
PUTCHR   EQU 00EH
CDERR    EQU 028H;
PUTSEC   EQU 010H
BUFSIZ   EQU 200H      ..I/O BUFFER OF MICRODISKS NEEDS 512 BYTES         R1.1->@-                    ..SAVE REGISTERS         R1.0->@-         R7.1->@-         R7.0->@-         R0.1->@-         R0.0->@-IOCBIN   @R6!->IOCBPT.1              ..POINT TO IOCB         @R6!->IOCBPT.0         IOCBPT.0+WRITEP->TMPRG1.0   ..ADVANCE POINTER TO WRITE PARAMETER         IOCBPT.1+"0->TMPRG1.1         0->@TMPRG1                  ..DEFAULT WRITE PARAMETER         INC TMPRG1         ->@TMPRG1         INC TMPRG1         ->@TMPRG1                   ..DEFAULT UNIT NO.=0         INC TMPRG1         9->TMPRG2.0                 ..SET UP LOOP COUNTLOOPIW   SPACE->@TMPRG1              ..BLANK OUT FILENAME & EXTENSION         INC TMPRG1         DEC TMPRG2         TMPRG2.0         LBNZ LOOPIW         TMPRG1.0+3->TMPRG1.0        ..POINT TO FILE DEFINITION         TMPRG1.1+"0->TMPRG1.1         2->@TMPRG1                  ..INITIALIZE TO ASCII FILE         TMPRG1.0+7->TMPRG1.0        ..POINT TO DEVICE MNENONIC         TMPRG1.1+"0->TMPRG1.1         'D'->@TMPRG1                ..SET DEVICE TO DISK         INC TMPRG1         'K'->@TMPRG1                ..IOCB INITIALIZED         A.0(PACKET)+3->TMPRG2.0     ..SETUP SRNAM PACKET         A.1(PACKET)+"0->TMPRG2.1         TMPRG1.0-21->@TMPRG2        ..SETUP OUTPUT POINTER FOR SRNAM         DEC TMPRG2         TMPRG1.1-"0->@TMPRG2         EXITFLNPTR   A.1(LINE)->IOCBPT.1         A.0(LINE)->IOCBPT.0SEARCH   @IOCBPT!.XOR.00DH;LBNZ SEARCH   ..SEARCH FOR CR         DEC IOCBPTEFND     A.1(INPTR)->TMPRG1.1        ..POINT INPTR AT CR         A.0(INPTR)->TMPRG1.0         IOCBPT.0->@TMPRG1         A.0(PACKET)->TMPRG2.0       ..SETUP INPUT POINTER FOR SRNAM         A.1(PACKET)->TMPRG2.1         A.1(LINE)->@TMPRG2          ..POINT TO FILENAME         INC TMPRG2         A.0(LINE)->@TMPRG2         CALL UCALL,A.0(SRNAM),PACKET  ..SCAN FILENAME         A.0(SRNERR)->IOCBPT.0         ..POINT TO ERROR BYTE         A.1(SRNERR)->IOCBPT.1         EXITAMUFT    CALL TOUT                   ..ERROR DETECTED, DIN         CALL ROCR         CALL STRNG,'INVALID FILENAME - READ',9FH         CALL SNCR         CALL UCALL,A.0(CDENT)CMUFT    CALL TOUT                   ..ERROR DETECTED, DOUT         CALL ROCR         CALL STRNG,'INVALID FILENAME - WRITE',9FH         CALL SNCR         CALL UCALL,A.0(CDENT)BMUFT    CALL ROCR         @IOCBPT.AND.001H            ..CHECK BIT 0         LBNZ BIT0CKB1     @IOCBPT.AND.002H            ..CHECK BIT 1         LBNZ BIT1CKB2     @IOCBPT.XOR.084H            ..CHECK BIT 2         LBZ BIT2CKB7     @IOCBPT.XOR.080H            ..CHECK BIT 7         LBZ BIT7         LBR SAGAINBIT0     CALL STRNG,'FAMILY INDICATOR FOUND IN THE NAME';DC 0D0AH,9FH         LBR CKB1BIT1     CALL STRNG,'FAMILY INDICATOR FOUND IN THE EXTENSION';DC 0D0AH,9FH         LBR SAGAINBIT2     CALL STRNG,'A DEVICE NAME WAS FOUND';DC 0D0AH,9FH         LBR CKB7BIT7     CALL STRNG,'A NULL FILENAME WAS FOUND';DC 0D0AH,9FHSAGAIN   CALL GETLN                  ..RFLN OR WFLN         CALL SNCR         CALL FLNPTR         EXITOPRF     CALL UCALL,A.0(OPEN),IOCBR  ..OPEN READ FILE         A.0(IOCBR)+1->IOCBPT.0         A.1(IOCBR)+"0->IOCBPT.1         EXITEREAD    CALL UCALL,A.0(CDERR),IOCBR ..CHECK FOR ERRORS         CALL ROCR         CALL GETLN         CALL IOCBIN,IOCBR         CALL SNCR         EXITOPWF     CALL UCALL,A.0(OPEN),IOCBW ..OPEN WRITE FILE         A.0(IOCBW)+1->IOCBPT.0         A.1(IOCBW)+"0->IOCBPT.1         EXITEWRITE   CALL UCALL,A.0(CDERR),IOCBW ..CHECK FOR ERRORS         CALL ROCR         CALL GETLN         CALL IOCBIN,IOCBW         CALL SNCR         EXITCLRF     CALL SNCR         CALL UCALL,A.0(CLOSE),IOCBR ..CLOSE READ FILE         EXITCLWF     CALL SNCR         R1.1->@-;R1.0->@-         A.0(IOCBW)->R1.0;A.1(IOCBW)->R1.1         @R1.XOR.42H         BNZ THISPT         INC R2;@!->R1.0;@->R1.1         BR SKIPITTHISPT   INC R2;@!->R1.0;@->R1.1         CALL UCALL,A.0(PUTSEC),IOCBW ..OUTPUT A SECTOR TO WRITE FILESKIPIT   CALL UCALL,A.0(CLOSE),IOCBW  ..CLOSE WRITE FILE         EXITCINIT    INC R2                      ..RESTORE REGISTERS         @!->R0.0         @!->R0.1         @!->R7.0         @!->R7.1         @!->R1.0         @->R1.1         CALL ROCR         EXITSNCR     A.1(CCALL)->R4.1            ..SET NEW CALL AND RETURN         A.0(CCALL)->R4.0         A.1(CRETN)->R5.1         A.0(CRETN)->R5.0         EXITROCR     A.1(CALL)->R4.1             ..RESTORE OLD CALL AND RETURN         A.0(CALL)->R4.0         A.1(RETN)->R5.1         A.0(RETN)->R5.0         EXIT         SEP 3CCALL    GHI 6;SEX 2;STXD;GLO 6;STXD         GLO 3;PLO 6;GHI 3;PHI 6         LDA 6;PHI 3;LDA 6;PLO 3;LBR CCALL-1         SEP 3CRETN    GHI 6;PHI 3;GLO 6;PLO 3;INC 2         LDA 2;PLO 6;LDN 2;PHI 6;SEX 2;LBR CRETN-1TRAV     CALL FLNPTR          ..RFLN ROUTINETUT      @IOCBPT;LBZ AOK;CALL BMUFT;LBR TUTAOK      CALL OPRF;@IOCBPT;LBNZ RERR;LBR CINITRERR     CALL EREAD;LBR TRAVSPAS     CALL FLNPTR                 ..WFLN ROUTINETUM      @IOCBPT         LBZ AOS         .XOR.84H         LBZ TUMMY         CALL BMUFT         LBR TUMTUMMY    R1.1->@-;R1.0->@-         R0.1->@-;R0.0->@-         A.0(IOCBW)->R1.0         A.1(IOCBW)->R1.1         42H->@R1         R1.0+0CH->R1.0         R1.1+"0->R1.1         A.0(IOCBW+1FH)->R0.0         A.1(IOCBW+1FH)->R0.1         @R1!->@R0;INC R0         @R1->@R0         INC R2         @!->R0.0         @!->R0.1         @!->R1.0         @->R1.1AOS      CALL OPWF;@IOCBPT;LBNZ WERR;LBR CINITWERR     CALL EWRITE;LBR SPASLDFLN    XRI 09FH;->@IOCBPT;INC IOCBPT..LOAD FILENAMEDFLN     LDA R6;XRI 09FH;LBNZ LDFLN;EXITIOCBR    DC 0B1H         DS 4         DC INBUF         DC INBUF+(BUFSIZ-1)         DS 27IOCBW    DC 7AH         DS 4         DC OUTBUF         DC OUTBUF+(BUFSIZ-1)         DS 27INBUF    DS BUFSIZ                      ..READ SECTOR BUFFEROUTBUF   DS BUFSIZ                      ..WRITE SECTOR BUFFERPACKET   DS 4                        ..SRNAM PACKETLIBRY    DS 10                       ..STORE LIBRARY FILENAME HERESCERR    R1.1->@-;R1.0->@-           ..CHECK FOR R/W ERRORS         R0.1->@-;R0.0->@-         A.0(IOCBST)->TMPRG1.0;A.1(IOCBST)->TMPRG1.1         @R6!->@TMPRG1,IOCBPT.1;INC TMPRG1         @R6!->@TMPRG1,IOCBPT.0;INC IOCBPT         @IOCBPT;LBNZ TRBLE;LBR SERGTRBLE    CALL UCALL,A.0(CDERR)IOCBST   DS 2         CALL UCALL,A.0(CDENT)SERG     INC R2;@!->R0.0;@!->R0.1         @!->R1.0;@->R1.1;EXIT0,0                     ..SRNAM PACKETLIBRY    DS 10                       ..STORE LIBRARY FILENAME HERESCERR    R1.1->@-;R1.0->@-        